<h1>Tier List Maker</h1>
<div class="tier-list">
  <div *ngFor="let tier of tiers; let i = index" class="tier-row"
    (dragover)="onDragOver($event)" (drop)="onDrop($event, i)">
    <!-- Section 1: Tier Label -->
    <div class="tier-label" [style.background]="tier.color" (click)="startEditLabel(i)">
      <ng-container *ngIf="editingLabelIdx === i; else labelDisplay">
        <textarea
          [value]="tier.name"
          (blur)="finishEditLabel(i, $event)"
          (keydown.enter)="finishEditLabel(i, $event)"
          autofocus
        ></textarea>
      </ng-container>
      <ng-template #labelDisplay>
        {{ tier.name }}
      </ng-template>
    </div>
    <!-- Section 2: Tier Characters -->
    <div class="tier-characters"
      (dragover)="onDragOver($event)"
      (drop)="onCharacterDrop($event, i, 0)"
      (click)="(selectedPoolCharIdx !== null || selectedTierCharIdx !== null) && placeSelectedCharacterInTier(i)">
      <ng-container *ngIf="tier.characters.length === 0">
        <div class="tier-empty-placeholder">
          Drop here
        </div>
      </ng-container>
      <ng-container *ngFor="let char of tier.characters; let j = index">
        <div class="tier-character"
          [class.selected]="selectedTierCharIdx?.tierIdx === i && selectedTierCharIdx?.charIdx === j"
          draggable="true"
          (dragstart)="onDragStart($event, i, j)"
          (dragover)="onDragOver($event)"
          (drop)="onCharacterDrop($event, i, j)"
          (click)="(selectedPoolCharIdx !== null || selectedTierCharIdx !== null) ? placeSelectedCharacterInTierAtIndex(i, j) : toggleTierCharacterSelection(i, j); $event.stopPropagation()">
          <img [src]="char.img" [alt]="char.name" class="character-img" />
          <div class="character-name">{{ char.name }}</div>
        </div>
      </ng-container>
      <!-- Allow dropping at the end of the tier -->
      <div class="tier-character tier-character-end"
        (dragover)="onDragOver($event)"
        (drop)="onCharacterDrop($event, i, tier.characters.length)"></div>
    </div>
    <!-- Section 3: Tier Settings -->
    <div class="tier-settings">
      <button class="tier-settings-btn" title="Tier Settings" (click)="openTierSettings(i)">
        <span class="material-icons">settings</span>
      </button>
      <div class="tier-settings-arrows">
        <button class="tier-settings-btn" title="Move Up" (click)="moveTierUp(i)" [disabled]="i === 0">
          <span class="material-icons">arrow_upward</span>
        </button>
        <button class="tier-settings-btn" title="Move Down" (click)="moveTierDown(i)" [disabled]="i === tiers.length - 1">
          <span class="material-icons">arrow_downward</span>
        </button>
      </div>
    </div>
  </div>
</div>
<app-tier-settings
  *ngIf="editingTierIdx !== null"
  [tierCount]="tiers.length"
  [tierName]="tiers[editingTierIdx].name"
  [tierColor]="tiers[editingTierIdx].color"
  (save)="updateTierSettings(editingTierIdx, $event.name, $event.color)"
  (cancel)="editingTierIdx = null"
  (delete)="deleteTier(editingTierIdx)"
  (newTierAbove)="insertTierAbove(editingTierIdx)"
  (newTierBelow)="insertTierBelow(editingTierIdx)"
></app-tier-settings>
<div class="character-pool"
  (dragover)="onDragOver($event)"
  (drop)="onPoolDrop($event)">
  <h2>Character Pool</h2>
  <div class="character-pool-list">
    <div *ngFor="let char of characterPool; let j = index" class="tier-character"
      [class.selected]="selectedPoolCharIdx === j"
      draggable="true"
      (dragstart)="onPoolDragStart($event, j)"
      (click)="selectedTierCharIdx !== null ? moveSelectedTierCharacterToPool(j) : togglePoolCharacterSelection(j)">
      <ng-container *ngIf="char.img; else noImg">
        <img [src]="char.img" [alt]="char.name" class="character-img" />
      </ng-container>
      <ng-template #noImg>
        <div class="character-img no-img">?</div>
      </ng-template>
      <div class="character-name">{{ char.name }}</div>
    </div>
  </div>
</div>
<div class="filter-section">
  <label for="characterFilter">Filter:</label>
  <select id="characterFilter" (change)="onFilterChange($event)">
    <option value="all">All characters</option>
    <option value="active">Active Characters</option>
    <option value="inactive">Inactive Characters</option>
    <option value="retired">Retired Characters</option>
    <option value="music">Music Enjoyers</option>
    <option value="side">Side Characters</option>
    <option value="male">Male Characters</option>
    <option value="female">Female Characters</option>
  </select>
  <br>
  <label for="splitTwins">Split Twins:</label>
  <input type="checkbox" id="splitTwins" (change)="onSplitTwinsChange($event)">
</div>
<footer>
  <button (click)="clear()" [style.background]="'#DD3333'" title="Clear all character selections">Clear</button>
  <button (click)="reset()" [style.background]="'#DD3333'" title="Reset all changes">Reset</button>
  <button (click)="import()" title="Import a tier list from JSON file">Import</button>
  <button (click)="export()" title="Export current tier list as image">Export</button>
  <button (click)="saveMetadataJSON()" title="Export tier list data as JSON">Export JSON</button>
</footer>
<app-text-viewer [textContent]="textViewerContent"></app-text-viewer>
<app-back-button></app-back-button>
<app-tier-screenshot [screenshotDataUrl]="screenshotDataUrl"></app-tier-screenshot>